{
  "gitSyncId": "6930adeefaf88d0819448125_607c697e-7a54-4dc0-9fc2-9e8ab8601a8d",
  "id": "INCIDENCIAS_CrearAlbaranWashtec",
  "pluginId": "restapi-plugin",
  "pluginType": "API",
  "unpublishedAction": {
    "actionConfiguration": {
      "autoGeneratedHeaders": [
        {
          "key": "content-type",
          "value": "application/json"
        }
      ],
      "body": "{\n  \"account-id\": {{ \n    (function() {\n       // USAMOS EL ID CONGELADO\n       const idFila = appsmith.store.id_averia_activa;\n       const original = get_averias.data.find(item => String(item.id) == String(idFila));\n       return (original && original['account-id']) ? original['account-id'] : 111;\n    })()\n  }},\n  \n  \"incident-id\": {{ appsmith.store.id_averia_activa }},\n  \n  \"date\": \"{{ moment().utc().format('YYYY-MM-DDTHH:mm:ss') + '+0000' }}\",\n\n  \"subject\": {{ \n    (function() {\n      // RECUPERAR TEXTO USANDO EL ID CONGELADO\n      const idFila = appsmith.store.id_averia_activa;\n      const original = get_averias.data.find(item => String(item.id) == String(idFila));\n      const texto = original ? (original.description || \"\") : \"\";\n\n      // 1. BUSCAR NÚMERO (Más flexible)\n      let numero = \"S/N\";\n      // Busca números largos de 6 a 12 cifras (ej: 000413...)\n      const matchNum = texto.match(/(\\d{6,12})/);\n      if (matchNum) numero = matchNum[1];\n\n      // 2. BUSCAR SITIO (Entre barras // o después de un guion largo)\n      let sitio = \"CLIENTE\";\n      const matchSitio = texto.match(/\\/\\/\\s*(.*?)\\s*\\/\\//);\n      \n      if (matchSitio) {\n          sitio = matchSitio[1].trim();\n      } else {\n          // Plan B: Busca algo que parezca un nombre de gasolinera (E.S, GALP, REPSOL)\n          const matchB = texto.match(/(E\\.S\\.|GALP|REPSOL|CEPSA|BP)\\s+.*?(?=\\n|\\r|\\/\\/)/i);\n          if (matchB) sitio = matchB[0].trim();\n      }\n\n      return numero + \" // \" + sitio + \" //\";\n    })() \n  }},\n\n  \"lines\": {{\n    (function() {\n      const lineas = [];\n      \n      // 1. HORAS (Leemos el valor seleccionado)\n      const horasVal = SelectHoras.selectedOptionValue;\n      // Truco: Si es nulo o texto, forzamos número. Si es 0, ponemos 1 por defecto.\n      const horas = Number(horasVal) || 1; \n      \n      lineas.push({\n        \"line-type\": \"ITEM\",\n        \"item-id\": 21124499, \n        \"quantity\": horas,\n        \"description\": \"Horas de Trabajo (HTW)\"\n      });\n\n      // 2. DESPLAZAMIENTO\n      const idDesp = Number(SelectDesplazamiento.selectedOptionValue);\n      if (idDesp && idDesp !== 0) {\n        lineas.push({\n          \"line-type\": \"ITEM\",\n          \"item-id\": idDesp,\n          \"quantity\": 1\n        });\n      }\n\n      // 3. MATERIALES\n      // (Aquí usamos tu Input o tu Cesta, lo que tengas configurado)\n      if (typeof InputMateriales !== 'undefined' && InputMateriales.text) {\n         lineas.push({\n            \"line-type\": \"ITEM\",\n            \"item-id\": 21124499,\n            \"quantity\": 1,\n            \"description\": \"MATERIALES: \" + InputMateriales.text\n         });\n      }\n\n      return lineas;\n    })()\n  }}\n}",
      "bodyFormData": [],
      "encodeParamsToggle": true,
      "formData": {
        "apiContentType": "application/json"
      },
      "headers": [],
      "httpMethod": "POST",
      "httpVersion": "HTTP11",
      "paginationType": "NONE",
      "path": "/workDeliveryNotes",
      "pluginSpecifiedTemplates": [
        {
          "value": true
        }
      ],
      "queryParameters": [],
      "timeoutInMillisecond": 10000
    },
    "confirmBeforeExecute": false,
    "datasource": {
      "id": "stel",
      "isAutoGenerated": false,
      "name": "stel",
      "pluginId": "restapi-plugin"
    },
    "dynamicBindingPathList": [
      {
        "key": "body"
      }
    ],
    "name": "CrearAlbaranWashtec",
    "pageId": "INCIDENCIAS",
    "runBehaviour": "MANUAL",
    "userSetOnLoad": false
  }
}