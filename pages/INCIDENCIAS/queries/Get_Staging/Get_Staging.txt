-- INCIDENCIAS UNIFICADAS
-- descripcion_problema = "INC02826\naveria|||emplazamiento|||modelo|||descripcion"
SELECT 
    SPLIT_PART(descripcion_problema, chr(10), 1) as referencia,
    cliente_nombre as cliente,
    SPLIT_PART(SPLIT_PART(descripcion_problema, chr(10), 2), '|||', 1) as numero_averia,
    direccion as emplazamiento,
    SPLIT_PART(SPLIT_PART(descripcion_problema, chr(10), 2), '|||', 3) as modelo,
    SPLIT_PART(SPLIT_PART(descripcion_problema, chr(10), 2), '|||', 4) as descripcion_averia,
    estado,
    'Sin asignar' as asignado_a,
    prioridad as urgencia,
    fecha_creacion as fecha_recepcion,
    id::text as numero_actividad,
    cliente_id_stel,
    'STEL' as origen
FROM public.incidencias

UNION ALL

SELECT 
    numero_actividad as referencia,
    COALESCE(fabricante, 'N8N') as cliente,
    numero_averia,
    emplazamiento,
    modelo,
    descripcion_averia,
    COALESCE(estado, 'Pendiente') as estado,
    COALESCE(asignado_a, 'Sin asignar') as asignado_a,
    urgencia,
    COALESCE(fecha_recepcion, fecha_creacion) as fecha_recepcion,
    numero_actividad,
    NULL::bigint as cliente_id_stel,
    'N8N' as origen
FROM public.incidencias_n8n

ORDER BY fecha_recepcion DESC;