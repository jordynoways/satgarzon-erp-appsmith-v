-- INCIDENCIAS UNIFICADAS
-- descripcion_problema = "REF\naveria\nemplazamiento\nmodelo\ndescripcion"
SELECT 
    SPLIT_PART(descripcion_problema, chr(10), 1) as referencia,
    cliente_nombre as cliente,
    SPLIT_PART(descripcion_problema, chr(10), 2) as numero_averia,
    direccion as emplazamiento,
    SPLIT_PART(descripcion_problema, chr(10), 4) as modelo,
    SPLIT_PART(descripcion_problema, chr(10), 5) as descripcion_averia,
    estado,
    prioridad as urgencia,
    fecha_creacion as fecha_recepcion,
    id::text as numero_actividad,
    cliente_id_stel,
    'STEL' as origen
FROM public.incidencias

UNION ALL

SELECT 
    numero_actividad as referencia,
    COALESCE(fabricante, 'N8N') as cliente,
    numero_averia,
    emplazamiento,
    modelo,
    descripcion_averia,
    COALESCE(estado, 'Pendiente') as estado,
    urgencia,
    COALESCE(fecha_recepcion, fecha_creacion) as fecha_recepcion,
    numero_actividad,
    NULL::bigint as cliente_id_stel,
    'N8N' as origen
FROM public.incidencias_n8n

ORDER BY fecha_recepcion DESC;