-- === INCIDENCIAS UNIFICADAS ===
-- descripcion_problema formato: "REF\nnumero_averia\nnumero_parte\nemplazamiento\ndireccion\ndescripcion"
SELECT 
    -- Referencia (INC02826)
    SPLIT_PART(descripcion_problema, chr(10), 1) as referencia,
    -- Cliente real (ISTOBAL ESPAÑA S.L.U)
    cliente_nombre as cliente,
    -- Nº Avería (ES00538724 / 413216055)
    SPLIT_PART(descripcion_problema, chr(10), 2) as numero_averia,
    -- Nº Parte (5637193446 para Istobal, vacío para WashTec)
    SPLIT_PART(descripcion_problema, chr(10), 3) as numero_parte,
    -- Emplazamiento (ESTACION SERVICIO GUIBE S L - RIVAS)
    COALESCE(NULLIF(direccion, ''), SPLIT_PART(descripcion_problema, chr(10), 4)) as emplazamiento,
    -- Dirección completa (C/.FUNDICION, 53 - 28522)
    SPLIT_PART(descripcion_problema, chr(10), 5) as direccion_completa,
    -- Descripción del problema
    SPLIT_PART(descripcion_problema, chr(10), 6) as descripcion_averia,
    -- Fabricante auto-detectado
    CASE 
        WHEN SPLIT_PART(descripcion_problema, chr(10), 2) LIKE 'ES%' THEN 'Istobal'
        WHEN SPLIT_PART(descripcion_problema, chr(10), 2) ~ '^\d+$' THEN 'WashTec'
        ELSE 'Otro'
    END as fabricante,
    estado,
    prioridad as urgencia,
    fecha_creacion as fecha_recepcion,
    id::text as numero_actividad,
    cliente_id_stel,
    'STEL' as origen
FROM public.incidencias

UNION ALL

-- N8N
SELECT 
    numero_actividad as referencia,
    COALESCE(fabricante, 'N8N') as cliente,
    numero_averia,
    numero_parte,
    emplazamiento,
    '' as direccion_completa,
    descripcion_averia,
    fabricante,
    COALESCE(estado, 'Pendiente') as estado,
    urgencia,
    COALESCE(fecha_recepcion, fecha_creacion) as fecha_recepcion,
    numero_actividad,
    NULL::bigint as cliente_id_stel,
    'N8N' as origen
FROM public.incidencias_n8n

ORDER BY fecha_recepcion DESC;