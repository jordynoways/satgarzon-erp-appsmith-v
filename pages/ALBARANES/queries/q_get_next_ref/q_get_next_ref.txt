SELECT 'A' || TO_CHAR(CURRENT_DATE, 'YYYY') || '/' || TO_CHAR(COALESCE((SELECT MAX(num) FROM (
	  SELECT CAST(SUBSTRING(referencia FROM '/([0-9]+)$') AS INTEGER) as num 
	  FROM public.albaranes 
	  WHERE referencia ~ ('^A' || TO_CHAR(CURRENT_DATE, 'YYYY') || '/[0-9]+$') 
	  UNION 
	  SELECT CAST(referencia AS INTEGER) as num 
	  FROM public.albaranes 
	  WHERE referencia ~ '^[0-9]+$' AND fecha >= DATE_TRUNC('year', CURRENT_DATE)
	) t), 0) + 1, 'fm0000') AS siguiente_ref;SELECT 'A' || TO_CHAR(CURRENT_DATE, 'YYYY') || '/' || TO_CHAR(COALESCE((SELECT MAX(CAST(SUBSTRING(referencia FROM '/([0-9]+)$') AS INTEGER)) FROM public.albaranes WHERE referencia ~ ('^A' || TO_CHAR(CURRENT_DATE, 'YYYY') || '/[0-9]+$')), 0) + 1, 'fm0000') AS siguiente_ref;