CREATE OR REPLACE FUNCTION importar_proveedores_stel(p_json json)
RETURNS void AS $$
DECLARE
  r json;
  addr json;
BEGIN
  FOR r IN SELECT * FROM json_array_elements(p_json)
  LOOP
    -- Extraer main-address (puede ser objeto vacÃ­o {})
    addr := r->'main-address';
    
    INSERT INTO public.proveedores (
      id, nombre_fiscal, nombre_comercial, cif_nif,
      direccion, poblacion, provincia, codigo_postal,
      telefono, email, referencia, id_stel
    ) VALUES (
      (r->>'id')::bigint,
      r->>'legal-name',
      r->>'name',
      r->>'tax-identification-number',
      CASE WHEN addr IS NOT NULL AND addr->>'address-data' IS NOT NULL 
           THEN addr->>'address-data' ELSE NULL END,
      CASE WHEN addr IS NOT NULL AND addr->>'city-town' IS NOT NULL 
           THEN addr->>'city-town' ELSE NULL END,
      CASE WHEN addr IS NOT NULL AND addr->>'province' IS NOT NULL 
           THEN addr->>'province' ELSE NULL END,
      CASE WHEN addr IS NOT NULL AND addr->>'postal-code' IS NOT NULL 
           THEN addr->>'postal-code' ELSE NULL END,
      r->>'phone',
      r->>'email',
      r->>'reference',
      (r->>'id')::bigint
    )
    ON CONFLICT (id) DO UPDATE SET
      nombre_fiscal = EXCLUDED.nombre_fiscal,
      nombre_comercial = EXCLUDED.nombre_comercial,
      cif_nif = EXCLUDED.cif_nif,
      direccion = EXCLUDED.direccion,
      poblacion = EXCLUDED.poblacion,
      provincia = EXCLUDED.provincia,
      codigo_postal = EXCLUDED.codigo_postal,
      telefono = EXCLUDED.telefono,
      email = EXCLUDED.email,
      referencia = EXCLUDED.referencia,
      id_stel = EXCLUDED.id_stel;
  END LOOP;
END;
$$ LANGUAGE plpgsql;
