{
  "gitSyncId": "694ce73ebe5af016d4a63fd2_8cca03d9-7a9c-4d4e-bf16-50ad26151749",
  "id": "FACTURAS_q_importar_facturas",
  "pluginId": "postgres-plugin",
  "pluginType": "DB",
  "unpublishedAction": {
    "actionConfiguration": {
      "body": "CREATE OR REPLACE FUNCTION importar_facturas_stel(data_json json)\nRETURNS text AS $$\nDECLARE\n    count_rows int;\nBEGIN\n    INSERT INTO public.facturas (\n        id_stel, referencia, fecha, id_cliente, nombre_cliente, \n        base_imponible, total, estado, id_albaran_origen, datos_json\n    )\n    SELECT \n        (obj->>'id')::text,\n        obj->>'full-reference',\n        (obj->>'date')::date, -- Usamos 'date' según tu doc\n        (obj->>'account-id')::text,\n        COALESCE(obj->>'legal-name', obj->>'account-id'), -- Si no viene nombre, ponemos el ID\n        (obj->>'subtotal-amount')::numeric,\n        (obj->>'total-amount')::numeric,\n        COALESCE(obj->>'document-state-name', 'Pendiente'),\n        (obj->>'parent-document-id')::text, -- Enlace al Albarán\n        obj::jsonb\n    FROM json_array_elements(data_json) AS obj\n    ON CONFLICT (id_stel) DO UPDATE SET\n        referencia = EXCLUDED.referencia,\n        fecha = EXCLUDED.fecha,\n        total = EXCLUDED.total,\n        id_albaran_origen = EXCLUDED.id_albaran_origen,\n        datos_json = EXCLUDED.datos_json,\n        actualizado_at = CURRENT_TIMESTAMP;\n\n    GET DIAGNOSTICS count_rows = ROW_COUNT;\n    RETURN 'Sincronizadas ' || count_rows || ' facturas.';\nEND;\n$$ LANGUAGE plpgsql;",
      "encodeParamsToggle": true,
      "paginationType": "NONE",
      "pluginSpecifiedTemplates": [
        {
          "value": true
        }
      ],
      "timeoutInMillisecond": 10000
    },
    "confirmBeforeExecute": false,
    "datasource": {
      "id": "postgres",
      "isAutoGenerated": false,
      "name": "postgres",
      "pluginId": "postgres-plugin"
    },
    "dynamicBindingPathList": [],
    "name": "q_importar_facturas",
    "pageId": "FACTURAS",
    "runBehaviour": "MANUAL",
    "userSetOnLoad": false
  }
}